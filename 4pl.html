<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4PL Calculator</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --text: #1e293b; --error: #ef4444; --secondary: #64748b; --border: #cbd5e1; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Drag and Drop Styles */
        #drop-zone {
            border: 2px dashed #cbd5e1; border-radius: 8px; background: var(--surface);
            padding: 40px; text-align: center; cursor: pointer; margin-bottom: 20px; transition: 0.2s;
        }
        #drop-zone:hover { border-color: var(--primary); }
        #drop-zone.dragover { border-color: var(--primary); background: #eff6ff; }
        #drop-zone.error { border-color: var(--error); background: #fef2f2; }

        /* Spreadsheet Styles */
        #manual-zone { display: none; background: var(--surface); padding: 20px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 20px; }
        
        .sheet-container { border: 1px solid var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .sheet-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .sheet-table th { background: #f1f5f9; padding: 8px; border-bottom: 1px solid var(--border); border-right: 1px solid #e2e8f0; font-weight: 600; color: var(--secondary); }
        .sheet-table td { padding: 0; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; }
        
        /* Row Highlighting for Standards */
        tr.is-standard { background-color: #f8fafc; }
        tr.is-standard input { font-weight: 500; color: var(--primary); }

        /* Input styling to look like spreadsheet cells */
        .cell-input {
            width: 100%; border: none; padding: 8px; box-sizing: border-box; outline: none; font-family: inherit; font-size: inherit; background: transparent;
        }
        .cell-input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px var(--primary); }
        .cell-select {
            width: 100%; border: none; padding: 7px; outline: none; background: transparent; cursor: pointer;
        }
        .cell-select:focus { background: #eff6ff; }

        .sheet-actions { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        
        .btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: var(--secondary); font-size: 0.9rem; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: #f1f5f9; }
        .btn-sm { padding: 4px 10px; font-size: 0.85rem; }

        .toggle-link { display: block; text-align: center; margin-bottom: 20px; color: var(--primary); cursor: pointer; font-size: 0.9rem; text-decoration: underline; }
        
        #status-msg { margin-top: 10px; font-weight: bold; color: var(--primary); }
        .error-text { color: var(--error) !important; }

        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; display: none; }
        .card { background: var(--surface); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Result Table */
        .res-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .res-table th, .res-table td { text-align: left; padding: 8px; border-bottom: 1px solid #e2e8f0; }
        
        .tag-warn { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: 600; }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8fafc; padding: 10px; text-align: center; border-radius: 4px; }
        .stat-box small { color: #64748b; font-size: 0.7rem; text-transform: uppercase; }
        .stat-box strong { display: block; font-size: 1.1rem; color: var(--primary); }
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-actions">
        <h1>4-PL Calculator <span style="font-size:0.6em; color:#64748b;">Interpolating from a sigmoidal standard curve</span></h1>
    </div>
    
    <div style="text-align: right; margin-bottom: 30px;">
        <button id="download-template-btn" class="btn btn-secondary">Download Example CSV</button>
    </div>

    <div id="drop-zone">
        <p>Drop CSV file here</p>
        <input type="file" id="file-input" style="display: none;" accept=".csv">
    </div>

    <div id="manual-zone">
        <div class="sheet-actions">
            <button id="add-row-btn" class="btn btn-outline btn-sm">+ Add Row</button>
            <button id="fill-preset-btn" class="btn btn-outline btn-sm" style="border-color:var(--primary); color:var(--primary);">Load Blank Table</button>
            <button id="fill-manual-example" class="btn btn-outline btn-sm">Load Example Data</button>
            <button id="clear-sheet-btn" class="btn btn-outline btn-sm" style="color:var(--error); border-color:var(--error);">Clear</button>
            <div style="flex-grow:1;"></div>
            <button id="process-manual-btn" class="btn btn-sm">Calculate Sheet</button>
        </div>

        <div class="sheet-container">
            <table class="sheet-table" id="input-grid">
                <thead>
                    <tr>
                        <th style="width: 120px;">Type</th>
                        <th>Sample Name</th>
                        <th style="width: 100px;">Conc</th>
                        <th style="width: 80px;">OD 1</th>
                        <th style="width: 80px;">OD 2</th>
                        <th style="width: 30px;"></th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div style="font-size:0.8rem; color:#64748b; text-align:right;">
            Tip: You can paste Excel/CSV blocks directly into the grid.
        </div>
    </div>

    <a id="toggle-mode-btn" class="toggle-link">Switch to Manual Spreadsheet</a>
    
    <div id="status-msg" style="text-align:center; margin-bottom:20px;"></div>

    <div id="dashboard" class="dashboard">
        <div class="card">
            <h3 style="margin-top:0;">Standard Curve</h3>
            <div class="stat-grid">
                <div class="stat-box"><small>Min (A)</small><strong id="p-A">-</strong></div>
                <div class="stat-box"><small>Slope (B)</small><strong id="p-B">-</strong></div>
                <div class="stat-box"><small>EC50 (C)</small><strong id="p-C">-</strong></div>
                <div class="stat-box"><small>Max (D)</small><strong id="p-D">-</strong></div>
            </div>
            <div style="height: 300px;"><canvas id="curveChart"></canvas></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Results</h3>
                <button id="copy-btn" class="btn">Copy Table</button>
            </div>
            <div style="overflow-y: auto; max-height: 400px; margin-top:15px;">
                <table id="results-table" class="res-table">
                    <thead>
                        <tr>
                            <th>Sample</th>
                            <th>Mean OD</th>
                            <th>CV%</th>
                            <th>Conc.</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 0. TEMPLATE DATA ---
    const EXAMPLE_CSV = 
`Type,Sample Name,Conc,OD_Rep1,OD_Rep2
Standard,,5000.0,2.368,2.344
Standard,,2500.0,1.475,1.462
Standard,,1250.0,0.919,0.889
Standard,,625.0,0.509,0.529
Standard,,313.0,0.33,0.322
Standard,,156.0,0.209,0.214
Standard,,78.1,0.151,0.151
Standard,,0.0,0.091,0.096
Sample,Control,,0.52,0.507
Sample,A1,,3.59,3.617
Sample,A2,,0.584,0.588
Sample,A3,,3.852,3.755
Sample,A1 (1:10),,2.097,2.037
Sample,A2 (1:10),,0.18,0.187
Sample,A3 (1:10),,2.261,2.224
Sample,Blank,,0.091,0.09`;

    // --- 1. SPREADSHEET LOGIC ---
    const gridBody = document.querySelector('#input-grid tbody');

    function createRow(data = {}) {
        const tr = document.createElement('tr');
        
        let typeStd = '';
        let typeSmp = '';
        
        // Handle explicit type from data, or default to Sample
        if (data.Type && data.Type.toLowerCase().includes('stand')) {
            typeStd = 'selected';
            tr.classList.add('is-standard');
        } else {
            typeSmp = 'selected';
        }
        
        tr.innerHTML = `
            <td>
                <select class="cell-select row-type" data-col="0" onchange="updateRowStyle(this)">
                    <option value="Standard" ${typeStd}>Standard</option>
                    <option value="Sample" ${typeSmp}>Sample</option>
                </select>
            </td>
            <td><input class="cell-input row-name" data-col="1" type="text" value="${data['Sample Name'] || ''}" placeholder="-"></td>
            <td><input class="cell-input row-conc" data-col="2" type="number" value="${data.Conc || ''}"></td>
            <td><input class="cell-input row-od1" data-col="3" type="number" step="0.001" value="${data.OD_Rep1 || ''}"></td>
            <td><input class="cell-input row-od2" data-col="4" type="number" step="0.001" value="${data.OD_Rep2 || ''}"></td>
            <td style="text-align:center;"><span style="cursor:pointer; color:#ef4444; font-weight:bold;" onclick="this.parentElement.parentElement.remove()">&times;</span></td>
        `;
        return tr;
    }
    
    // Helper to change row color when "Standard" is selected
    window.updateRowStyle = function(selectEl) {
        const row = selectEl.closest('tr');
        if(selectEl.value === 'Standard') row.classList.add('is-standard');
        else row.classList.remove('is-standard');
    }

    function addRow(data) { gridBody.appendChild(createRow(data)); }
    
    // Initialize with preset
    for(let i=0; i<8; i++) addRow({Type:'Standard'});
    addRow({Type:'Sample'});

    // --- BUTTON EVENTS ---
    document.getElementById('add-row-btn').onclick = () => addRow({Type:'Sample'}); // Default new rows to sample
    
    document.getElementById('clear-sheet-btn').onclick = () => { 
        gridBody.innerHTML = ''; 
        addRow({Type:'Sample'}); 
    };

    // THE NEW PRESET BUTTON
    document.getElementById('fill-preset-btn').onclick = () => {
        gridBody.innerHTML = '';
        // 8 Standards
        for(let i=0; i<8; i++) addRow({Type:'Standard'});
        // 1 Sample
        addRow({Type:'Sample'});
    };
    
    document.getElementById('fill-manual-example').onclick = () => {
        gridBody.innerHTML = '';
        Papa.parse(EXAMPLE_CSV, {
            header: true, skipEmptyLines: true,
            complete: (res) => { res.data.forEach(row => addRow(row)); }
        });
    };

    // --- SMART PASTE HANDLER ---
    gridBody.addEventListener('paste', function(e) {
        e.preventDefault();
        const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
        if (!clipboardData) return;
        const rows = clipboardData.split(/\r\n|\n|\r/).filter(r => r.trim() !== '');
        if (rows.length === 0) return;

        let target = e.target;
        if (!target.classList.contains('cell-input') && !target.classList.contains('cell-select')) return;
        
        let startRow = target.closest('tr');
        let startColIndex = parseInt(target.getAttribute('data-col'));
        let currentRow = startRow;

        rows.forEach((rowStr) => {
            const cells = rowStr.split('\t');
            if (!currentRow) {
                addRow({Type:'Sample'}); // Default paste extension to Sample
                currentRow = gridBody.lastElementChild;
            }

            const inputs = currentRow.querySelectorAll('.cell-select, .cell-input');
            
            cells.forEach((cellData, i) => {
                const targetIndex = startColIndex + i;
                if (targetIndex < inputs.length) {
                    const input = inputs[targetIndex];
                    if (input.tagName === 'SELECT') {
                        const val = cellData.toLowerCase();
                        if (val.includes('std') || val.includes('standard')) {
                            input.value = 'Standard';
                            currentRow.classList.add('is-standard');
                        } else {
                            input.value = 'Sample';
                            currentRow.classList.remove('is-standard');
                        }
                    } else {
                        input.value = cellData.trim();
                    }
                }
            });
            currentRow = currentRow.nextElementSibling;
        });
    });

    // --- DATA SCRAPING ---
    function scrapeGridData() {
        const rows = Array.from(gridBody.querySelectorAll('tr'));
        const data = [];
        
        rows.forEach(tr => {
            const type = tr.querySelector('.row-type').value;
            const name = tr.querySelector('.row-name').value;
            const conc = tr.querySelector('.row-conc').value;
            const od1 = tr.querySelector('.row-od1').value;
            const od2 = tr.querySelector('.row-od2').value;

            if(od1 || od2) {
                data.push({
                    "Type": type,
                    "Sample Name": name,
                    "Conc": conc,
                    "OD_Rep1": od1,
                    "OD_Rep2": od2
                });
            }
        });
        return data;
    }

    document.getElementById('process-manual-btn').onclick = () => {
        const data = scrapeGridData();
        if(data.length === 0) setStatus("Grid is empty or missing OD values.", true);
        else processData(data);
    };


    // --- 2. SOLVER ENGINE ---
    const Solver = {
        minimize: function (func, x0, options = {}) {
            const maxIter = options.maxIter || 5000;
            const tol = options.tol || 1e-8;
            const step = options.step || 1.05;
            let dim = x0.length;
            let simplex = [];
            simplex[0] = { p: x0.slice(), f: func(x0) };
            for (let i = 0; i < dim; i++) {
                let p = x0.slice();
                p[i] = p[i] ? p[i] * step : 0.001; 
                simplex[i + 1] = { p: p, f: func(p) };
            }
            simplex.sort((a, b) => a.f - b.f);
            
            for(let iter = 0; iter < maxIter; iter++) {
                let best = simplex[0];
                let worst = simplex[dim];
                let secondWorst = simplex[dim-1];
                let centroid = new Array(dim).fill(0);
                for(let i=0; i<dim; i++) for(let j=0; j<dim; j++) centroid[j] += simplex[i].p[j];
                for(let j=0; j<dim; j++) centroid[j] /= dim;
                
                let xr = centroid.map((v,k) => v + 1.0 * (v - worst.p[k]));
                let fr = func(xr);
                if(fr < secondWorst.f && fr >= best.f) {
                    simplex[dim] = {p:xr, f:fr};
                } else if(fr < best.f) {
                    let xe = centroid.map((v,k) => v + 2.0 * (v - worst.p[k]));
                    let fe = func(xe);
                    simplex[dim] = (fe < fr) ? {p:xe, f:fe} : {p:xr, f:fr};
                } else {
                    let xc = centroid.map((v,k) => v + 0.5 * (v - worst.p[k]));
                    let fc = func(xc);
                    if(fc < worst.f) simplex[dim] = {p:xc, f:fc};
                    else {
                        for(let i=1; i<=dim; i++) {
                            simplex[i].p = simplex[i].p.map((v,k) => best.p[k] + 0.5 * (v - best.p[k]));
                            simplex[i].f = func(simplex[i].p);
                        }
                    }
                }
                simplex.sort((a, b) => a.f - b.f);
                if (Math.abs(simplex[0].f - simplex[dim].f) < tol) break;
            }
            return simplex[0].p;
        }
    };

    // --- 3. 4PL MATH & PROCESSING ---
    const predict = (x, [A, B, C, D]) => D + (A - D) / (1 + Math.pow(x / C, B));
    const calcConc = (y, A, B, C, D) => {
        let term = (A - y) / (y - D);
        if (term <= 0) return NaN;
        return C * Math.pow(term, 1 / B);
    };
    const costFunction = (params, standards) => {
        let sse = 0;
        for(let s of standards) {
            let pred = predict(s.x, params);
            sse += Math.pow(s.y - pred, 2);
        }
        return sse;
    };

    const setStatus = (msg, isError = false) => {
        const el = document.getElementById('status-msg');
        el.innerHTML = msg;
        el.className = isError ? 'error-text' : '';
        document.getElementById('drop-zone').className = isError ? 'error' : '';
    };

    const getStats = (vals) => {
        if (!vals.length) return { mean: 0, cv: 0 };
        const mean = vals.reduce((a,b)=>a+b, 0) / vals.length;
        if (vals.length === 1) return { mean, cv: 0 };
        const variance = vals.reduce((a,b)=>a + Math.pow(b-mean,2), 0) / (vals.length-1);
        const cv = mean ? (Math.sqrt(variance)/mean)*100 : 0;
        return { mean, cv };
    };

    function processData(csvData) {
        try {
            // Flexible Column matching
            const headers = Object.keys(csvData[0]);
            const findCol = (s) => headers.find(h => h.toLowerCase().includes(s.toLowerCase()));
            
            const colType = findCol('type');
            const colConc = findCol('conc');
            const colName = headers.find(h => h.toLowerCase().includes('name') || h.toLowerCase().includes('sample id'));
            
            const odCols = headers.filter(h => {
                let lower = h.toLowerCase();
                return (lower.includes('od') || lower.includes('abs')) && !lower.includes('conc') && !lower.includes('type');
            });

            if (!colType || !colConc || odCols.length === 0) throw new Error("Missing columns (Type, Conc, or OD)");

            const standards = [];
            const samples = [];

            csvData.forEach(row => {
                const typeRaw = row[colType];
                if (!typeRaw) return;
                const type = String(typeRaw).toLowerCase();
                const ods = odCols.map(c => parseFloat(row[c])).filter(v => !isNaN(v));
                if (ods.length === 0) return;
                
                const stats = getStats(ods);
                const conc = parseFloat(row[colConc]);

                if (type.includes("std") || type.includes("standard")) {
                    if (!isNaN(conc) && conc > 0) standards.push({ x: conc, y: stats.mean, cv: stats.cv });
                } else if (type.includes("sample") || type.includes("unk")) {
                    let sName = colName && row[colName] ? String(row[colName]) : "";
                    if (!sName || sName.trim() === "") sName = `Sample ${samples.length + 1}`;
                    samples.push({ id: sName, y: stats.mean, cv: stats.cv });
                }
            });

            if (standards.length < 4) throw new Error("Need at least 4 Standards.");
            setStatus(`Optimizing Curve... <span class="spinner"></span>`);

            setTimeout(() => {
                const fit = runMultiStageFit(standards);
                updateDashboard(fit, standards, samples);
                setStatus("Calculations Complete", false);
            }, 50);

        } catch (err) {
            console.error(err);
            setStatus("Error: " + err.message, true);
        }
    }

    function runMultiStageFit(standards) {
        const yVals = standards.map(s => s.y);
        const xVals = standards.map(s => s.x);
        const minStd = Math.min(...yVals);
        const maxStd = Math.max(...yVals);
        const xSorted = [...xVals].sort((a,b)=>a-b);
        const medianX = xSorted[Math.floor(xSorted.length/2)];
        
        let params = [minStd, 1.0, medianX, maxStd]; 
        params = Solver.minimize(p => costFunction(p, standards), params, { maxIter: 2000, tol: 1e-4, step: 1.1 });
        params = Solver.minimize(p => costFunction(p, standards), params, { maxIter: 5000, tol: 1e-8, step: 1.02 });
        params = Solver.minimize(p => costFunction(p, standards), params, { maxIter: 10000, tol: 1e-10, step: 1.001 });

        return { params, minStd, maxStd };
    }

    // --- 4. DASHBOARD ---
    let myChart = null;

    function updateDashboard(fit, standards, samples) {
        document.getElementById('dashboard').style.display = 'grid';
        const [A, B, C, D] = fit.params;
        ['A','B','C','D'].forEach((k,i) => document.getElementById(`p-${k}`).innerText = fit.params[i].toFixed(4));

        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = '';
        
        samples.forEach(s => {
            const od = s.y;
            const conc = calcConc(od, A, B, C, D);
            let concStr = "";
            let statusHtml = "OK";
            
            if (isNaN(conc)) {
                if (od < A) { concStr = "< LOD"; statusHtml = `<span class="tag-warn">Low</span>`; }
                else if (od > D) { concStr = "> Range"; statusHtml = `<span class="tag-warn">High</span>`; }
                else { concStr = "Error"; statusHtml = `<span class="tag-warn">Fit Err</span>`; }
            } else {
                concStr = conc.toFixed(1);
                if (od < fit.minStd || od > fit.maxStd) statusHtml = `<span class="tag-warn">Extrapolated</span>`;
            }
            if (s.cv > 15) statusHtml += ` <span class="tag-warn" title="High CV">CV ${s.cv.toFixed(0)}%</span>`;

            tbody.innerHTML += `<tr><td>${s.id}</td><td>${od.toFixed(3)}</td><td>${s.cv.toFixed(1)}%</td><td><strong>${concStr}</strong></td><td>${statusHtml}</td></tr>`;
        });

        // --- CHART GENERATION ---
        const ctx = document.getElementById('curveChart').getContext('2d');
        const xVals = standards.map(s => s.x);
        const minX = Math.min(...xVals);
        const maxX = Math.max(...xVals);
        
        const plotMin = minX * 0.5;
        const plotMax = maxX * 1.5;
        const pts = [];
        const steps = 100;
        
        const logMin = Math.log10(plotMin);
        const logMax = Math.log10(plotMax);
        
        for(let i=0; i<=steps; i++) {
            let logVal = logMin + (i/steps)*(logMax - logMin);
            let x = Math.pow(10, logVal);
            pts.push({x, y: predict(x, fit.params)});
        }

        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                { label: 'Standards', data: standards, backgroundColor: 'rgba(37, 99, 235, 0.3)', borderColor: '#2563eb', borderWidth: 1, pointRadius: 3 },
                    { label: 'Fit', data: pts, type: 'line', borderColor: '#dc2626', pointRadius: 0, borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        type: 'logarithmic', // Log Scale
                        position: 'bottom', 
                        title: {display:true, text:'Concentration (Log Scale)'},
                        min: plotMin,
                        max: plotMax
                    },
                    y: { title: {display:true, text:'Optical Density'} }
                }
            }
        });
    }

    // --- 5. GLOBAL EVENTS ---
    const dropZone = document.getElementById('drop-zone');
    const manualZone = document.getElementById('manual-zone');
    const toggleBtn = document.getElementById('toggle-mode-btn');
    const fileInput = document.getElementById('file-input');
    const copyBtn = document.getElementById('copy-btn');
    const dlTemplateBtn = document.getElementById('download-template-btn');

    let isManual = false;
    toggleBtn.onclick = () => {
        isManual = !isManual;
        if(isManual) {
            dropZone.style.display = 'none';
            manualZone.style.display = 'block';
            toggleBtn.innerText = "Switch to File Upload";
        } else {
            dropZone.style.display = 'block';
            manualZone.style.display = 'none';
            toggleBtn.innerText = "Switch to Manual Spreadsheet";
        }
        setStatus("");
    };

    const handleFile = (file) => {
        Papa.parse(file, {
            header: true, skipEmptyLines: true,
            complete: (res) => { if(res.data.length) processData(res.data); else setStatus("Empty File", true); }
        });
    };

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); };
    
    ['dragenter','dragover','dragleave','drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }));
    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { dropZone.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });

    copyBtn.onclick = () => {
        const table = document.getElementById("results-table");
        let text = "";
        for (let row of table.rows) text += Array.from(row.cells).map(c => c.innerText).join("\t") + "\n";
        navigator.clipboard.writeText(text).then(() => alert("Copied!"));
    };

    dlTemplateBtn.onclick = () => {
        const blob = new Blob([EXAMPLE_CSV], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "ELISA_Template.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
</script>
</body>
</html>